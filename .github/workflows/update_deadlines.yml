name: Weekly Deadlines Mailer

on:
  schedule:
    - cron: '0 0 * * 1'  # æ¯å‘¨ä¸€ UTC 0 ç‚¹è¿è¡Œï¼ˆæ–°åŠ å¡æ—¶é—´å‘¨ä¸€æ—©ä¸Š 8 ç‚¹ï¼‰
  workflow_dispatch:

jobs:
  send-deadlines:
    runs-on: self-hosted

    steps:
    - name: Download target conference YAMLs
      run: |
        mkdir -p data
        curl -sL https://raw.githubusercontent.com/ccfddl/ccf-deadlines/main/conference/AI/iclr.yml -o data/iclr.yml
        curl -sL https://raw.githubusercontent.com/ccfddl/ccf-deadlines/main/conference/AI/nips.yml -o data/nips.yml
        curl -sL https://raw.githubusercontent.com/ccfddl/ccf-deadlines/main/conference/AI/icml.yml -o data/icml.yml
        curl -sL https://raw.githubusercontent.com/ccfddl/ccf-deadlines/main/conference/AI/ijcai.yml -o data/ijcai.yml
        curl -sL https://raw.githubusercontent.com/ccfddl/ccf-deadlines/main/conference/AI/aaai.yml -o data/aaai.yml
        curl -sL https://raw.githubusercontent.com/ccfddl/ccf-deadlines/main/conference/AI/cvpr.yml -o data/cvpr.yml
        curl -sL https://raw.githubusercontent.com/ccfddl/ccf-deadlines/main/conference/AI/iccv.yml -o data/iccv.yml
        curl -sL https://raw.githubusercontent.com/ccfddl/ccf-deadlines/main/conference/AI/eccv.yml -o data/eccv.yml
        curl -sL https://raw.githubusercontent.com/ccfddl/ccf-deadlines/main/conference/AI/rss.yml -o data/rss.yml
        curl -sL https://raw.githubusercontent.com/ccfddl/ccf-deadlines/main/conference/AI/icra.yml -o data/icra.yml
        curl -sL https://raw.githubusercontent.com/ccfddl/ccf-deadlines/main/conference/AI/corl.yml -o data/corl.yml

    - name: Install dependencies
      shell: zsh {0}
      run: |
        eval "$(/Users/fanggan/miniconda3/bin/conda shell.zsh hook)"
        conda activate base
        python -m pip install --upgrade pip
        python -m pip install pyyaml

    - name: Generate and send email
      shell: zsh {0}
      run: |
        eval "$(/Users/fanggan/miniconda3/bin/conda shell.zsh hook)"
        conda activate base
        python <<'PYCODE'
        import yaml, datetime, glob

        # AoE æ—¶åŒº (UTC-12) - ä¼šè®® deadline é€šå¸¸ä»¥æ­¤ä¸ºå‡†
        AoE = datetime.timezone(datetime.timedelta(hours=-12))
        
        # ç”¨ AoE æ—¶åŒºè®¡ç®—"ä»Šå¤©"
        now_aoe = datetime.datetime.now(AoE)
        today_aoe = now_aoe.date()
        
        # åŒæ—¶æ˜¾ç¤ºæ–°åŠ å¡æ—¶é—´ä¾›å‚è€ƒ
        SGT = datetime.timezone(datetime.timedelta(hours=8))
        now_sgt = datetime.datetime.now(SGT)
        
        lines = [
            f"ğŸ“… æ¯å‘¨ä¼šè®®æˆªç¨¿æé†’ï¼ˆWeekly Conference Deadlines Updateï¼‰",
            f"ğŸ“† æ›´æ–°æ—¶é—´ï¼š{now_sgt.strftime('%Y-%m-%d %H:%M')} SGT",
            f"â° å‰©ä½™æ—¶é—´æŒ‰ AoE æ—¶åŒºè®¡ç®—ï¼ˆUTC-12ï¼Œæ¯”æ–°åŠ å¡æ™š 20 å°æ—¶ï¼‰",
            ""
        ]

        def parse_conf(path):
            with open(path) as f:
                data = yaml.safe_load(f)

            items = data if isinstance(data, list) else [data]

            for item in items:
                name = item.get("title", path.split("/")[-1].split(".")[0].upper())
                confs = item.get("confs", [])
                for c in confs:
                    year = c.get("year")
                    place = c.get("place", "")
                    for tl in c.get("timeline", []):
                        ddl = tl.get("deadline")
                        abs_ddl = tl.get("abstract_deadline")
                        if ddl and (not abs_ddl or abs_ddl != ddl):
                            try:
                                # è§£æ deadline æ—¥æœŸ
                                date = datetime.datetime.fromisoformat(ddl.split()[0]).date()
                                # ç”¨ AoE æ—¶åŒºè®¡ç®—å‰©ä½™å¤©æ•°
                                days = (date - today_aoe).days
                                if days >= 0:
                                    date_str = date.strftime("%Yå¹´%mæœˆ%dæ—¥")
                                    # æ·»åŠ ç´§æ€¥ç¨‹åº¦æç¤º
                                    if days == 0:
                                        urgency = "ğŸ”´ ä»Šå¤©æˆªæ­¢ï¼"
                                    elif days <= 3:
                                        urgency = "ğŸŸ  ç´§æ€¥"
                                    elif days <= 7:
                                        urgency = "ğŸŸ¡ æœ¬å‘¨å†…"
                                    else:
                                        urgency = ""
                                    
                                    lines.append(
                                        f"ğŸ¯ {name} {year} {urgency}\n"
                                        f"ğŸ—“ï¸ æˆªç¨¿æ—¥æœŸï¼š{date_str}ï¼ˆå‰©ä½™ {days} å¤©ï¼‰\n"
                                        f"ğŸ“ ä¸¾åŠåœ°ï¼š{place}\n"
                                    )
                            except Exception:
                                lines.append(
                                    f"ğŸ¯ {name} {year}\n"
                                    f"ğŸ—“ï¸ æˆªç¨¿æ—¥æœŸï¼š{ddl}\n"
                                    f"ğŸ“ ä¸¾åŠåœ°ï¼š{place}\n"
                                )

        for path in sorted(glob.glob("data/*.yml")):
            parse_conf(path)

        body = "\n".join(lines)
        print("=== é‚®ä»¶å†…å®¹é¢„è§ˆ ===\n" + body + "\n==================")

        with open("body.txt", "w") as f:
            f.write(body)
        PYCODE



    - name: Send email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        secure: true
        username: ${{ secrets.MAIL_USER }}
        password: ${{ secrets.MAIL_PASS }}
        subject: "Weekly AI/CV Conference Deadlines"
        to: ${{ secrets.MAIL_TO }}
        from: "GitHub Actions <${{ secrets.MAIL_USER }}>"
        body: file://body.txt
